YUI.add("aui-scheduler-event-recorder",function(e,t){var n=e.Lang,r=n.isObject,i=n.isString,s=n.isUndefined,o=e.IO.prototype._serialize,u=function(t){return t instanceof e.NodeList},a=e.DataType.DateMath,f="-",l=".",c=" ",h="scheduler-event",p="scheduler-event-recorder",d="activeView",v="bodyTemplate",m="boundingBox",g="cancel",y="click",b="clickoutside",w="content",E="contentBox",S="dateFormat",x="delete",T="endDate",N="event",C="eventChange",k="headerTemplate",L="isoTime",A="node",O="popover",M="recorder",_="rendered",D="save",P="scheduler",H="schedulerChange",B="startDate",j="strings",F="submit",I="top",q="visibleChange",R=e.getClassName,U=R(h),z=R(h,M),W=R(h,M,w),X=R(h,M,O),V='<form class="scheduler-event-recorder-form" id="schedulerEventRecorderForm"></form>',$='<input type="hidden" name="startDate" value="{startDate}" /><input type="hidden" name="endDate" value="{endDate}" /><label class="scheduler-event-recorder-date">{date}</label>',J='<input class="'+W+'" name="content" value="{content}" />',K=e.Component.create({NAME:p,ATTRS:{allDay:{value:!1},content:{},duration:{value:60},dateFormat:{validator:i,value:"%a, %B %d,"},event:{},eventClass:{valueFn:function(){return e.SchedulerEvent}},popover:{setter:"_setPopover",validator:r,value:{}},strings:{value:{},setter:function(t){return e.merge({"delete":"Delete","description-hint":"e.g., Dinner at Brian's",cancel:"Cancel",description:"Description",edit:"Edit",save:"Save",when:"When"},t||{})},validator:r},bodyTemplate:{value:$},headerTemplate:{value:J}},EXTENDS:e.SchedulerEvent,prototype:{initializer:function(){var t=this;t.get(A).addClass(z),t.publish("cancel",{defaultFn:t._defCancelEventFn}),t.publish("delete",{defaultFn:t._defDeleteEventFn}),t.publish("edit",{defaultFn:t._defEditEventFn}),t.publish("save",{defaultFn:t._defSaveEventFn}),t.after(C,t._afterEventChange),t.after(H,t._afterSchedulerChange),t.popover=new e.Popover(t.get(O)),t.popover.after(q,e.bind(t._afterPopoverVisibleChange,t))},_afterEventChange:function(){var e=this;e.populateForm()},_afterPopoverVisibleChange:function(e){var t=this;if(e.newVal){t.populateForm();if(!t.get(N)){var n=t.getContentNode();n&&setTimeout(function(){n.selectText()},0)}}else t.set(N,null,{silent:!0}),t.get(A).remove()},_afterSchedulerChange:function(t){var n=this,r=t.newVal,i=r.get(m);i.delegate(y,e.bind(n._onClickSchedulerEvent,n),l+U)},_defCancelEventFn:function(){var e=this;e.get(A).remove(),e.hidePopover()},_defDeleteEventFn:function(){var e=this,t=e.get(P);t.removeEvents(e.get(N)),e.hidePopover(),t.syncEventsUI()},_defEditEventFn:function(){var e=this,t=e.get(P);e.hidePopover(),t.syncEventsUI()},_defSaveEventFn:function(e){var t=this,n=t.get(P);n.addEvents(e.newSchedulerEvent),t.hidePopover(),n.syncEventsUI()},_getFooterToolbar:function(){var t=this,n=t.get(N),r=t.get(j),i=[{label:r[D],on:{click:e.bind(t._handleSaveEvent,t)}},{label:r[g],on:{click:e.bind(t._handleCancelEvent,t)}}];return n&&i.push({label:r[x],on:{click:e.bind(t._handleDeleteEvent,t)}}),[i]},_handleCancelEvent:function(e){var t=this;t.fire("cancel"),e.domEvent&&e.domEvent.preventDefault(),e.preventDefault()},_handleClickOutSide:function(){var e=this;e.fire("cancel")},_handleDeleteEvent:function(e){var t=this;t.fire("delete",{schedulerEvent:t.get(N)}),e.domEvent&&e.domEvent.preventDefault(),e.preventDefault()},_handleEscapeEvent:function(t){var n=this;n.popover.get(_)&&t.keyCode===e.Event.KeyMap.ESC&&(n.fire("cancel"),t.preventDefault())},_handleSaveEvent:function(e){var t=this,n=t.get(N)?"edit":"save";t.fire(n,{newSchedulerEvent:t.getUpdatedSchedulerEvent()}),e.domEvent&&e.domEvent.preventDefault(),e.preventDefault()},_onClickSchedulerEvent:function(e){var t=this,n=e.currentTarget.getData(h);n&&(t.set(N,n,{silent:!0}),t.showPopover(e.currentTarget),t.get(A).remove())},_onSubmitForm:function(e){var t=this;t._handleSaveEvent(e)},_renderPopover:function(){var t=this,n=t.get(P),r=n.get(m);t.popover.render(r),t.formNode=e.Node.create(V),t.formNode.on(F,e.bind(t._onSubmitForm,t)),t.popover.get(m).addClass(X),t.popover.get(E).wrap(t.formNode),r.on(b,e.bind(t._handleClickOutSide,t))},_setPopover:function(t){var n=this;return e.merge({align:{points:[e.WidgetPositionAlign.BC,e.WidgetPositionAlign.TC]},bodyContent:$,constrain:!0,headerContent:J,preventOverlap:!0,position:I,toolbars:{footer:n._getFooterToolbar()},visible:!1,zIndex:500},t)},getContentNode:function(){var e=this,t=e.popover.get(m);return t.one(l+W)},getFormattedDate:function(){var e=this,t=e.get(S),n=e.get(N)||e,r=n.get(T),i=n.get(P),s=n.get(B),o=i.get(d).get(L)?a.toIsoTimeString:a.toUsTimeString;return[n._formatDate(s,t),o(s),f,o(r)].join(c)},getTemplateData:function(){var e=this,t=e.get(j),n=e.get(N)||e,r=n.get(w);return s(r)&&(r=t["description-hint"]),{content:r,date:e.getFormattedDate(),endDate:n.get(T).getTime(),startDate:n.get(B).getTime()}},getUpdatedSchedulerEvent:function(t){var n=this,r=n.get(N),i={silent:!r},s=n.serializeForm();return r||(r=n.clone()),r.set(P,n.get(P),{silent:!0}),r.setAttrs(e.merge(s,t),i),r},hidePopover:function(){var e=this;e.popover.hide()},populateForm:function(){var t=this,n=t.get(v),r=t.get(k),i=t.getTemplateData();t.popover.setStdModContent("body",e.Lang.sub(n,i)),t.popover.setStdModContent("header",e.Lang.sub(r,i)),t.popover.addToolbar(t._getFooterToolbar(),"footer")},serializeForm:function(){var t=this;return e.QueryString.parse(o(t.formNode.getDOM()))},showPopover:function(e){var t=this,n=t.get(N);t.popover.get(_)||t._renderPopover(),e||(n?e=n.get(A):e=t.get(A)),u(e)&&(e=e.item(0)),t.popover.set("align.node",e),t.popover.show()}}});e.SchedulerEventRecorder=K},"2.0.0pr5",{requires:["querystring","io-form","overlay","aui-scheduler-base","aui-popover"],skinnable:!0});
